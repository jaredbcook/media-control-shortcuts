# Media Control Shortcuts - Agent Instructions

## Project Overview

A Chrome/Firefox/Safari browser extension that adds keyboard shortcuts for controlling HTML5 media playback. The extension is intended to work across the entire web, including media in iframes and Shadow DOMs.

## File Structure

```
src/
  scripts/
    content.js       # Main content script (all media control logic)
  options.html       # Options page UI
  options.js         # Options page logic
  options.css        # Options page styles
  manifest.json      # Extension manifest (Manifest V3)
  test.html          # Test page for manual testing
  test-iframe.html   # Test page for iframe scenarios
  images/            # Extension icons and material icons

dist/                # Built extensions (generated by build script)
  chrome/
  firefox/
  safari/

tests/
  content.test.js    # Unit tests for content script

scripts/
  build.js           # Build script
  zip.js             # Release packaging script
```

## Architecture

**Content Script** (`src/scripts/content.js`):
- Runs on every page, injected into all frames
- Detects `<video>` and `<audio>` elements dynamically (including Shadow DOM)
- Listens for keyboard events and translates them to media control actions
- Communicates with iframes via `postMessage` API for cross-frame control
- Tracks "last interacted media" to intelligently select which media element to control
- Renders temporary overlays with icons to provide visual feedback

**Smart Media Selection** (priority order):
1. Active focused element (if it's a media element)
   - Example: User clicks on a video element
2. Currently playing media
   - Example: Media with `!paused && !ended && readyState > 2`
3. Most recently interacted media
   - Tracked via `lastInteractedMedia` variable
   - Verified to still exist in document before use
4. First media element on the page
   - Fallback if no other criteria match

**Edge Cases:**
- Multiple playing media: First found is selected
- Iframe media: Content script runs independently per frame
- Shadow DOM: Recursively searched via `findMedia()`

**Action System**:
- Actions are constants like `ACTION_PLAY_PAUSE`, `ACTION_SEEK_FWD_LARGE`
- Mapped from keys via `mapKeyToAction()` → applied via `runAction()`
- Settings (min/max speed, step amounts) should be loaded from `chrome.storage.sync` (not implemented yet)

**Action Constants:**
- `ACTION_PLAY_PAUSE` - Toggle play/pause (key: `k`)
- `ACTION_MUTE_UNMUTE` - Toggle mute (key: `m`)
- `ACTION_VOLUME_UP` - Increase volume (key: `]`)
- `ACTION_VOLUME_DOWN` - Decrease volume (key: `[`)
- `ACTION_SPEED_UP` - Increase playback speed (key: `>`)
- `ACTION_SPEED_DOWN` - Decrease playback speed (key: `<`)
- `ACTION_SEEK_FWD_LARGE` - Seek forward 10s (key: `l`)
- `ACTION_SEEK_BACK_LARGE` - Seek backward 10s (key: `j`)
- `ACTION_SEEK_FWD_SMALL` - Seek forward 5s (key: `.`)
- `ACTION_SEEK_BACK_SMALL` - Seek backward 5s (key: `,`)
- `ACTION_SEEK_PERCENTAGE_0` through `ACTION_SEEK_PERCENTAGE_90` - Jump to 0-90% (keys: `0-9`)

**Action Object Structure:**
Actions passed to `runAction(media, action)` have this structure:
```javascript
{
  type: string,        // Action constant (e.g., 'MCS_EXT_PLAY_PAUSE')
  change?: number,     // Change value for incremental actions (speed, volume, seek)
  seekPercentage?: number  // Percentage (0-0.9) for seek percentage actions
}
```

**Options Page** (`src/options.html`, `options.js`):
- **Currently Configurable:**
  - `minSpeed` - Minimum playback speed (default: 0.25)
  - `maxSpeed` - Maximum playback speed (default: 4.0)
  - `speedStep` - Playback speed increment (default: 0.25)
- **Not Yet Configurable** (hard-coded in `content.js`):
  - `seekStepLarge`, `seekStepSmall` - Seek step sizes
  - `volumeStep` - Volume increment
  - Keyboard shortcut mappings
  - Overlay display settings
- Syncs to `chrome.storage.sync` for cross-device persistence
- Settings are NOT automatically loaded in content script (see TODOs in `content.js`)

## Key Design Patterns

**Dynamic Media Detection**:
- `findMedia(root)` recursively searches DOM and Shadow DOMs
- `MutationObserver` watches for newly added video/audio/iframe elements
- Lazy listener activation—only enabled if media or iframes exist

**Cross-Frame Communication**:
- Uses `postMessage` to forward keyboard commands to iframe content scripts
- Each frame runs its own content script instance independently
- Frame isolation by design (per Manifest V3 security model)

**Overlay System**:
- Creates temporary, absolutely positioned `<div>` over media elements
- Auto-removes after brief fade-out animation
- Displays action icons (Material Symbols) + numeric values (speed, seek duration)

**State Management:**
- `lastInteractedMedia` - Tracks the most recently controlled media element for smart selection
- `listenersActive` - Flag to prevent duplicate event listener registration
- Settings variables (`maxSpeed`, `minSpeed`, etc.) are module-level but should be loaded from storage

## General Instructions

Before writing any code:
1. State how you will verify each change works (test, bash command, browser check, etc.)
2. Write the test for the verification first
3. Implement the code
4. Run verification and iterate until it passes

Other general instructions:
- Keep AGENTS.md and README.md updated when you make other changes to the codebase
- Refer to official documentation and examples for Chrome, Firefox, and Safari extension development
- Prefer the latest versions of modern, popular, well-documented libraries and tools
- Make recommendations for different technologies or architecture patterns when appropriate

## Code Style

- Use consistent naming conventions and variable names
- Add JSDoc-style comments for documentation and type annotations for all functions and classes

## Testing

**Test Framework:**
- Vitest (test runner)
- JSDOM (DOM environment simulation)
- Located in `tests/` directory

**Running Tests:**
```bash
npm test              # Run all tests
npm test -- --watch   # Watch mode
```

**Test Structure:**
- `tests/content.test.js` - Unit tests for content script functions
- Tests cover: key mapping, action execution, media detection, volume controls
- Uses JSDOM for DOM simulation (shadow DOM tests are commented out)

**Writing Tests:**
- Import functions from `src/scripts/content.js` (note: file must use CommonJS exports for testing)
- Mock media elements with `document.createElement('video')`
- Use Vitest's `vi.fn()` for mocking methods like `play()` and `pause()`

**General Guidelines:**
- Add or update unit tests and functional tests for all features you create or modify
- Use Vitest, TestingLibrary, and JSDOM

## Build & Release Workflow

**Build Process:**
```bash
npm run build    # Copies src/ to dist/{chrome,firefox,safari}
npm run release  # Zips dist folders to releases/ (except Safari)
```

**Build Script Behavior:**
- Source files are in `src/` directory
- Build copies all files from `src/` to `dist/{browser}/`
- Firefox-specific: `adjustManifestForFirefox()` currently does minimal adjustments (placeholder for future gecko ID if needed)
- Safari: No automated build (requires manual Xcode project setup)

**Multi-browser Support:**
- Build script prepares separate distributions per browser
- Firefox gets manifest adjustments (see `adjustManifestForFirefox()`)
- Safari requires manual Xcode build (not automated)

**Directory Structure:**
- `src/` - Source files (edit here)
- `dist/` - Built extensions (generated by build script)
- `releases/` - Zipped releases (generated)

## Configuration

Settings stored in `chrome.storage.sync` with defaults:
```javascript
{
  minSpeed: 0.25,
  maxSpeed: 4.0,
  speedStep: 0.25,
  seekStepLarge: 10,    // seconds
  seekStepSmall: 5,     // seconds
  volumeStep: 0.1       // 0-1 scale
}
```

**Note:** Only `minSpeed`, `maxSpeed`, and `speedStep` are currently configurable via the options page. Other settings are hard-coded in `content.js` and should be loaded dynamically in the future (see `TODO` comments).

## Extension Permissions & APIs

- `storage` permission for synced settings
- `content_scripts` runs on `<all_urls>` with `all_frames: true`
- `run_at: document_end` ensures DOM is ready

## Browser Compatibility

**Manifest V3:**
- Chrome: Full support
- Firefox: Supported (requires manifest adjustments in build script)
- Safari: Requires manual Xcode project setup (not automated)

**APIs Used:**
- `chrome.storage.sync` - Settings storage (works in all Manifest V3 browsers)
- `content_scripts` with `all_frames: true` - Content script injection
- `postMessage` API - Cross-frame communication

## Keyboard Shortcuts Reference

| Key | Action | Default Value |
|-----|--------|---------------|
| `k` | Play/Pause | Toggle |
| `m` | Mute/Unmute | Toggle |
| `]` | Volume Up | +10% |
| `[` | Volume Down | -10% |
| `>` | Speed Up | +0.25x |
| `<` | Speed Down | -0.25x |
| `l` | Seek Forward (Large) | +10s |
| `j` | Seek Backward (Large) | -10s |
| `.` | Seek Forward (Small) | +5s |
| `,` | Seek Backward (Small) | -5s |
| `0` | Jump to 0% | 0% |
| `1-9` | Jump to 10%-90% | 10% increments |

## Common Tasks

- **Add new keyboard shortcut**: Add constant + `mapKeyToAction()` case + action handler in `runAction()`
- **Add new overlay icon**: Embed SVG constant at top of content.js, use in `showOverlay()`
- **Change default settings**: Edit `DEFAULTS` in `options.js` and corresponding vars in `content.js`
- **Test cross-frame**: Check `test-iframe.html` and `test.html` for iframe scenarios
- **Fix media element detection**: Enhance `findMedia()` or `MutationObserver` logic

## Development Workflow

**Manual Testing:**
1. Run `npm run build` to generate dist files
2. Load unpacked extension from `dist/chrome/` (or firefox/safari)
3. Open `dist/chrome/test.html` or `test-iframe.html` in browser to test functionality
4. Reload extension after code changes (no hot reload)

**Debugging:**
- Content script logs to browser console
- Check `chrome.runtime.id` to detect extension context invalidation
- MutationObserver watches for dynamically added media elements

**Testing Cross-Frame:**
- Use `test-iframe.html` to verify postMessage communication works
- Content script runs in all frames (`all_frames: true` in manifest)

## Known Limitations & TODOs

**Implementation Status:**
- ✅ Volume up/down **IS implemented** (keys: `]` and `[`)
- ❌ Settings not loaded from storage in content script yet
- ❌ Keyboard shortcuts and overlay display not configurable via UI
- ❌ Seek step sizes and volume step not configurable via options page

**Architecture:**
- No service worker (manifest V3 doesn't require background scripts for this extension)
- Safari build process not automated (requires manual Xcode project setup)

**Code Quality Issues:**
- `ACTION_NEXT_FRAME` and `ACTION_PREV_FRAME` are referenced in `runAction()` but not defined as constants (lines 326-331)
- `lastInteractedMedia` is used globally but not declared with `let` or `const`

**Future Enhancements:**
- Need to check conflicts with site-specific keyboard shortcuts (e.g. YouTube, Netflix, Vimeo, etc.) and consider adding a "disable on this site" option
- Consider adding support for more media control actions (e.g. toggle captions, full screen, etc.)
- Consider storing playback speed and other settings per domain automatically and restoring them when the user revisits the site
